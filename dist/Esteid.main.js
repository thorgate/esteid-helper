!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Esteid=e():t.Esteid=e()}(window,function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(i,n,function(e){return t[e]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=6)}([function(t,e,r){var i,n=r(2),s=r(3),o=r(4),a=r(1);function u(){}function h(t){switch({}.toString.call(t)){case"[object File]":case"[object Blob]":case"[object FormData]":return!0;default:return!1}}i="undefined"!=typeof window?window:"undefined"!=typeof self?self:this;var c=t.exports=r(5).bind(null,m);c.getXHR=function(){if(!(!i.XMLHttpRequest||i.location&&"file:"==i.location.protocol&&i.ActiveXObject))return new XMLHttpRequest;try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){}return!1};var l="".trim?function(t){return t.trim()}:function(t){return t.replace(/(^\s*|\s*$)/g,"")};function p(t){if(!a(t))return t;var e=[];for(var r in t)null!=t[r]&&d(e,r,t[r]);return e.join("&")}function d(t,e,r){if(Array.isArray(r))return r.forEach(function(r){d(t,e,r)});t.push(encodeURIComponent(e)+"="+encodeURIComponent(r))}function f(t){for(var e,r={},i=t.split("&"),n=0,s=i.length;n<s;++n)e=i[n].split("="),r[decodeURIComponent(e[0])]=decodeURIComponent(e[1]);return r}function y(t){return/[\/+]json\b/.test(t)}function g(t,e){e=e||{},this.req=t,this.xhr=this.req.xhr,this.text="HEAD"!=this.req.method&&(""===this.xhr.responseType||"text"===this.xhr.responseType)||void 0===this.xhr.responseType?this.xhr.responseText:null,this.statusText=this.req.xhr.statusText,this.setStatusProperties(this.xhr.status),this.header=this.headers=function(t){var e,r,i,n,s=t.split(/\r?\n/),o={};s.pop();for(var a=0,u=s.length;a<u;++a)e=(r=s[a]).indexOf(":"),i=r.slice(0,e).toLowerCase(),n=l(r.slice(e+1)),o[i]=n;return o}(this.xhr.getAllResponseHeaders()),this.header["content-type"]=this.xhr.getResponseHeader("content-type"),this.setHeaderProperties(this.header),this.body="HEAD"!=this.req.method?this.parseBody(this.text?this.text:this.xhr.response):null}function m(t,e){var r=this;this._query=this._query||[],this.method=t,this.url=e,this.header={},this._header={},this.on("end",function(){var t=null,e=null;try{e=new g(r)}catch(e){return(t=new Error("Parser is unable to parse the response")).parse=!0,t.original=e,t.rawResponse=r.xhr&&r.xhr.responseText?r.xhr.responseText:null,t.statusCode=r.xhr&&r.xhr.status?r.xhr.status:null,r.callback(t)}if(r.emit("response",e),t)return r.callback(t,e);if(e.status>=200&&e.status<300)return r.callback(t,e);var i=new Error(e.statusText||"Unsuccessful HTTP response");i.original=t,i.response=e,i.status=e.status,r.callback(i,e)})}for(var _ in c.serializeObject=p,c.parseString=f,c.types={html:"text/html",json:"application/json",xml:"application/xml",urlencoded:"application/x-www-form-urlencoded",form:"application/x-www-form-urlencoded","form-data":"application/x-www-form-urlencoded"},c.serialize={"application/x-www-form-urlencoded":p,"application/json":JSON.stringify},c.parse={"application/x-www-form-urlencoded":f,"application/json":JSON.parse},g.prototype.get=function(t){return this.header[t.toLowerCase()]},g.prototype.setHeaderProperties=function(t){var e=this.header["content-type"]||"";this.type=e.split(/ *; */).shift();var r=function(t){return s(t.split(/ *; */),function(t,e){var r=e.split(/ *= */),i=r.shift(),n=r.shift();return i&&n&&(t[i]=n),t},{})}(e);for(var i in r)this[i]=r[i]},g.prototype.parseBody=function(t){var e=c.parse[this.type];return!e&&y(this.type)&&(e=c.parse["application/json"]),e&&t&&(t.length||t instanceof Object)?e(t):null},g.prototype.setStatusProperties=function(t){1223===t&&(t=204);var e=t/100|0;this.status=this.statusCode=t,this.statusType=e,this.info=1==e,this.ok=2==e,this.clientError=4==e,this.serverError=5==e,this.error=(4==e||5==e)&&this.toError(),this.accepted=202==t,this.noContent=204==t,this.badRequest=400==t,this.unauthorized=401==t,this.notAcceptable=406==t,this.notFound=404==t,this.forbidden=403==t},g.prototype.toError=function(){var t=this.req,e=t.method,r=t.url,i="cannot "+e+" "+r+" ("+this.status+")",n=new Error(i);return n.status=this.status,n.method=e,n.url=r,n},c.Response=g,n(m.prototype),o)m.prototype[_]=o[_];function b(t,e){var r=c("DELETE",t);return e&&r.end(e),r}m.prototype.abort=function(){if(!this.aborted)return this.aborted=!0,this.xhr&&this.xhr.abort(),this.clearTimeout(),this.emit("abort"),this},m.prototype.type=function(t){return this.set("Content-Type",c.types[t]||t),this},m.prototype.responseType=function(t){return this._responseType=t,this},m.prototype.accept=function(t){return this.set("Accept",c.types[t]||t),this},m.prototype.auth=function(t,e,r){switch(r||(r={type:"basic"}),r.type){case"basic":var i=btoa(t+":"+e);this.set("Authorization","Basic "+i);break;case"auto":this.username=t,this.password=e}return this},m.prototype.query=function(t){return"string"!=typeof t&&(t=p(t)),t&&this._query.push(t),this},m.prototype.attach=function(t,e,r){return this._getFormData().append(t,e,r||e.name),this},m.prototype._getFormData=function(){return this._formData||(this._formData=new i.FormData),this._formData},m.prototype.send=function(t){var e=a(t),r=this._header["content-type"];if(e&&a(this._data))for(var i in t)this._data[i]=t[i];else"string"==typeof t?(r||this.type("form"),r=this._header["content-type"],this._data="application/x-www-form-urlencoded"==r?this._data?this._data+"&"+t:t:(this._data||"")+t):this._data=t;return!e||h(t)?this:(r||this.type("json"),this)},g.prototype.parse=function(t){return i.console&&console.warn("Client-side parse() method has been renamed to serialize(). This method is not compatible with superagent v2.0"),this.serialize(t),this},g.prototype.serialize=function(t){return this._parser=t,this},m.prototype.callback=function(t,e){var r=this._callback;this.clearTimeout(),r(t,e)},m.prototype.crossDomainError=function(){var t=new Error("Request has been terminated\nPossible causes: the network is offline, Origin is not allowed by Access-Control-Allow-Origin, the page is being unloaded, etc.");t.crossDomain=!0,t.status=this.status,t.method=this.method,t.url=this.url,this.callback(t)},m.prototype.timeoutError=function(){var t=this._timeout,e=new Error("timeout of "+t+"ms exceeded");e.timeout=t,this.callback(e)},m.prototype.withCredentials=function(){return this._withCredentials=!0,this},m.prototype.end=function(t){var e=this,r=this.xhr=c.getXHR(),i=this._query.join("&"),n=this._timeout,s=this._formData||this._data;this._callback=t||u,r.onreadystatechange=function(){if(4==r.readyState){var t;try{t=r.status}catch(e){t=0}if(0==t){if(e.timedout)return e.timeoutError();if(e.aborted)return;return e.crossDomainError()}e.emit("end")}};var o=function(t){t.total>0&&(t.percent=t.loaded/t.total*100),t.direction="download",e.emit("progress",t)};this.hasListeners("progress")&&(r.onprogress=o);try{r.upload&&this.hasListeners("progress")&&(r.upload.onprogress=o)}catch(t){}if(n&&!this._timer&&(this._timer=setTimeout(function(){e.timedout=!0,e.abort()},n)),i&&(i=c.serializeObject(i),this.url+=~this.url.indexOf("?")?"&"+i:"?"+i),this.username&&this.password?r.open(this.method,this.url,!0,this.username,this.password):r.open(this.method,this.url,!0),this._withCredentials&&(r.withCredentials=!0),"GET"!=this.method&&"HEAD"!=this.method&&"string"!=typeof s&&!h(s)){var a=this._header["content-type"],l=this._parser||c.serialize[a?a.split(";")[0]:""];!l&&y(a)&&(l=c.serialize["application/json"]),l&&(s=l(s))}for(var p in this.header)null!=this.header[p]&&r.setRequestHeader(p,this.header[p]);return this._responseType&&(r.responseType=this._responseType),this.emit("request",this),r.send(void 0!==s?s:null),this},c.Request=m,c.get=function(t,e,r){var i=c("GET",t);return"function"==typeof e&&(r=e,e=null),e&&i.query(e),r&&i.end(r),i},c.head=function(t,e,r){var i=c("HEAD",t);return"function"==typeof e&&(r=e,e=null),e&&i.send(e),r&&i.end(r),i},c.del=b,c.delete=b,c.patch=function(t,e,r){var i=c("PATCH",t);return"function"==typeof e&&(r=e,e=null),e&&i.send(e),r&&i.end(r),i},c.post=function(t,e,r){var i=c("POST",t);return"function"==typeof e&&(r=e,e=null),e&&i.send(e),r&&i.end(r),i},c.put=function(t,e,r){var i=c("PUT",t);return"function"==typeof e&&(r=e,e=null),e&&i.send(e),r&&i.end(r),i}},function(t,e){t.exports=function(t){return null!=t&&"object"==typeof t}},function(t,e,r){function i(t){if(t)return function(t){for(var e in i.prototype)t[e]=i.prototype[e];return t}(t)}t.exports=i,i.prototype.on=i.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},i.prototype.once=function(t,e){function r(){this.off(t,r),e.apply(this,arguments)}return r.fn=e,this.on(t,r),this},i.prototype.off=i.prototype.removeListener=i.prototype.removeAllListeners=i.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var r,i=this._callbacks["$"+t];if(!i)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var n=0;n<i.length;n++)if((r=i[n])===e||r.fn===e){i.splice(n,1);break}return this},i.prototype.emit=function(t){this._callbacks=this._callbacks||{};var e=[].slice.call(arguments,1),r=this._callbacks["$"+t];if(r)for(var i=0,n=(r=r.slice(0)).length;i<n;++i)r[i].apply(this,e);return this},i.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},i.prototype.hasListeners=function(t){return!!this.listeners(t).length}},function(t,e){t.exports=function(t,e,r){for(var i=0,n=t.length,s=3==arguments.length?r:t[i++];i<n;)s=e.call(null,s,t[i],++i,t);return s}},function(t,e,r){var i=r(1);e.clearTimeout=function(){return this._timeout=0,clearTimeout(this._timer),this},e.parse=function(t){return this._parser=t,this},e.timeout=function(t){return this._timeout=t,this},e.then=function(t,e){return this.end(function(r,i){r?e(r):t(i)})},e.use=function(t){return t(this),this},e.get=function(t){return this._header[t.toLowerCase()]},e.getHeader=e.get,e.set=function(t,e){if(i(t)){for(var r in t)this.set(r,t[r]);return this}return this._header[t.toLowerCase()]=e,this.header[t]=e,this},e.unset=function(t){return delete this._header[t.toLowerCase()],delete this.header[t],this},e.field=function(t,e){return this._getFormData().append(t,e),this}},function(t,e){t.exports=function(t,e,r){return"function"==typeof r?new t("GET",e).end(r):2==arguments.length?new t("GET",e):new t(e,r)}},function(t,e,r){"use strict";r.r(e);var i=r(0),n=r.n(i);const s="EST",o=[s,"ENG","RUS","LIT"];let a={user_cancel:{[s]:"Allkirjastamine katkestati",ENG:"Signing was cancelled",LIT:"Pasirašymas nutrauktas",RUS:"Подпись была отменена"},no_certificates:{[s]:"Sertifikaate ei leitud",ENG:"Certificate not found",LIT:"Nerastas sertifikatas",RUS:"Сертификат не найден"},invalid_argument:{[s]:"Vigane sertifikaadi identifikaator",ENG:"Invalid certificate identifier",LIT:"Neteisingas sertifikato identifikatorius",RUS:"Неверный идентификатор сертификата"},no_implementation:{[s]:"Vajalik tarkvara on puudu",ENG:"Unable to find software",LIT:"Nerasta programinės įranga",RUS:"Отсутствует необходимое программное обеспечение"},technical_error:{[s]:"Tehniline viga",ENG:"Technical error",LIT:"Techninė klaida",RUS:"Техническая ошибка"},not_allowed:{[s]:"Veebis allkirjastamise käivitamine on võimalik vaid https aadressilt",ENG:"Web signing is allowed only from https:// URL",LIT:"Web signing is allowed only from https:// URL",RUS:"Подпись в интернете возможна только с URL-ов, начинающихся с https://"}};var u=class{constructor(t){this.language=t||s,this._cert=null}initializeIdCard(){return new Promise(function(t,e){window.hwcrypto.use("auto")?t():e("Backend selection failed")})}getCertificate(){return new Promise((t,e)=>{let r={lang:this.language};window.hwcrypto.getCertificate(r).then(e=>{this._cert=e,t()},t=>{e(t)})})}signHexData(t){return new Promise((e,r)=>{let i={lang:this.language};window.hwcrypto.sign(this._cert,{type:"SHA-256",hex:t},i).then(t=>{this._signature=t,e()},t=>{r(t)})})}get prepareSignatureData(){return{tokenId:null,certData:this._cert.hex}}get finalizeSignatureData(){return{tokenId:null,signature:this._signature.hex}}get language(){return this._language}set language(t){-1!==o.indexOf(t)&&(this._language=t)}getError(t){return void 0!==a[t]?{error_code:t,message:a[t][this.language]}:{error_code:"technical_error",message:a.technical_error[this.language]}}};class h{constructor(t){const e={language:null,idEndpoints:{start:null,finish:null,finalize:null},midEndpoints:{start:null,status:null,finalize:null},...t};this.idCardManager=new u(e.language),this.idEndpoints=e.idEndpoints,this.midEndpoints=e.midEndpoints}sign(t,e,r){return new Promise((r,i)=>{t===h.SIGN_ID?this.__signHandleId(e,r,i):t===h.SIGN_MOBILE?this.__signHandleMid(e,r,i):i("IdentificationManager: Bad signType")})}__signHandleId(t,e,r){this.idCardManager.initializeIdCard().then(()=>{this.idCardManager.getCertificate().then(()=>{let i=this.idCardManager.prepareSignatureData;n.a.post(this.idEndpoints.start).type("form").send({certificate:i.certData,token_id:i.tokenId}).send(t).end((i,n)=>{n.ok&&n.body.success?this.__attemptSign(n.body.id,n.body.digest,t,e,r):r(n.body)})},r)},r)}__attemptSign(t,e,r,i,s){this.idCardManager.signHexData(e).then(()=>{let e=this.idCardManager.finalizeSignatureData;n.a.post(this.idEndpoints.finish).type("form").send({signature_value:e.signature,signature_id:t}).send(r).end((t,e)=>{e.ok&&e.body.success?i(e.body):s(e.body)})},s)}__signHandleMid(t,e,r){n.a.post(this.midEndpoints.start).type("form").send(t).end(function(t,i){i.ok&&i.body.success?e(i.body):r(i.body)})}midStatus(t,e){return new Promise((r,i)=>{if(t){var s=()=>{n.a.post(this.midEndpoints.status).type("form").send(e).end((t,e)=>{e.ok?e.body.success?r(e.body):e.body.pending?setTimeout(s,1e3):i(e.body):i(e.body)})};s()}else i("skipped")})}getError(t){return this.idCardManager.getError(t)}}h.SIGN_ID="id",h.SIGN_MOBILE="mid";var c={IdentificationManager:h,Languages:{ET:s,EN:"ENG",RU:"RUS",LT:"LIT"}};e.default=c}])});